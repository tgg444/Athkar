<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ذاكر - أبو الحسن tgg4</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --muted: #64748b;
            --border: #e2e8f0;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f1f5f9;
            --muted: #94a3b8;
            --border: #334155;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; transition: 0.3s; }

        /* Credits Banner */
        .tgg4-rights { background: var(--primary); color: white; padding: 10px; text-align: center; font-size: 13px; font-weight: 800; z-index: 5000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        /* Navigation & Header */
        .app-header { padding: 15px 20px; background: var(--card); display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); }
        .app-header h1 { font-size: 20px; font-weight: 900; color: var(--primary); }
        .header-icons { display: flex; gap: 20px; font-size: 22px; cursor: pointer; color: var(--muted); }

        /* Search Bar */
        .search-container { padding: 15px 20px; }
        .search-box { background: var(--card); display: flex; align-items: center; padding: 12px 18px; border-radius: 18px; border: 2.5px solid var(--primary); box-shadow: var(--shadow); }
        .search-box input { border: none; outline: none; width: 100%; background: transparent; color: var(--text); font-size: 15px; padding: 0 10px; }

        /* Main Content Views */
        .content-view { flex: 1; overflow-y: auto; padding: 10px 20px 200px; display: none; }
        .content-view.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .section-label { margin: 20px 0 12px; font-size: 16px; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; }

        /* Grid Items */
        .grid-layout { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 12px; }
        .grid-tile { background: var(--card); padding: 22px 10px; border-radius: 18px; text-align: center; font-size: 14px; font-weight: 700; box-shadow: var(--shadow); border: 1.5px solid var(--border); cursor: pointer; transition: 0.2s; }
        .grid-tile:active { transform: scale(0.9); background: var(--primary); color: white; }

        /* List Items */
        .track-tile { background: var(--card); margin-bottom: 15px; padding: 18px; border-radius: 22px; display: flex; align-items: center; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .track-meta { flex: 1; margin-left: 15px; overflow: hidden; }
        .track-meta h4 { font-size: 15px; font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .btn-play-circle { width: 48px; height: 48px; background: var(--primary); color: white; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; }

        /* Mini Player */
        .mini-bar { position: fixed; bottom: 90px; left: 15px; right: 15px; background: var(--card); height: 75px; border-radius: 24px; display: none; align-items: center; padding: 0 18px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); border: 2px solid var(--primary); z-index: 1000; }

        /* --- Full Player Page --- */
        .full-player { position: fixed; inset: 0; background: var(--bg); z-index: 4000; display: none; flex-direction: column; padding: 40px 30px; text-align: center; }
        .disk-art { position: relative; width: 220px; height: 220px; margin: 40px auto; border-radius: 60px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); display: flex; align-items: center; justify-content: center; color: white; font-size: 90px; box-shadow: 0 20px 40px rgba(16, 185, 129, 0.3); }
        
        /* New Loader Overlay */
        .loader-wrap { position: absolute; inset: 0; background: rgba(0,0,0,0.7); border-radius: 60px; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10; backdrop-filter: blur(4px); }
        .spin-loader { width: 45px; height: 45px; border: 4px solid rgba(255,255,255,0.2); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #btn-manual-trigger { display: none; background: var(--primary); color: white; border: none; padding: 18px 40px; border-radius: 40px; font-weight: 800; margin-top: 25px; font-size: 17px; cursor: pointer; box-shadow: 0 0 25px var(--primary); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Progress Bar (RTL Fix) */
        .progress-container { margin: 40px 0 20px; }
        .bar-bg { width: 100%; height: 12px; background: var(--border); border-radius: 20px; position: relative; cursor: pointer; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--primary); position: absolute; right: 0; top: 0; width: 0%; border-radius: 20px; }
        .time-labels { display: flex; justify-content: space-between; margin-top: 15px; font-size: 14px; font-weight: 800; color: var(--text); }

        .main-controls { display: flex; justify-content: center; align-items: center; gap: 40px; margin-top: 20px; }
        .btn-big-play { width: 90px; height: 90px; background: var(--primary); color: white; border-radius: 50%; border: none; font-size: 40px; box-shadow: 0 15px 30px rgba(16, 185, 129, 0.4); cursor: pointer; }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; justify-content: space-around; padding: 12px 0 35px; border-top: 1px solid var(--border); z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 11px; color: #94a3b8; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--primary); font-weight: 900; }
        .nav-item i { font-size: 22px; }
    </style>
</head>
<body>

    <!-- Credits (Rights for Abu Al-Hassan) -->
    <div class="tgg4-rights">تطوير: أبو الحسن tgg4 - نسألكم الدعاء لي ولوالديّ بالتوفيق</div>

    <header class="app-header">
        <div class="header-icons">
            <i class="fas fa-moon" onclick="toggleDark()"></i>
            <i class="fas fa-circle-question" onclick="showHelp()"></i>
        </div>
        <h1>ذاكر</h1>
        <i class="fas fa-hourglass-half" onclick="setSleepTimer()"></i>
    </header>

    <div class="search-container">
        <div class="search-box">
            <i class="fas fa-magnifying-glass" style="color:var(--primary)" onclick="performSearch()"></i>
            <input type="text" id="qInput" placeholder="ابحث عن قارئ أو سورة أو دعاء...">
        </div>
    </div>

    <!-- Main Screens -->
    <main id="view-home" class="content-view active">
        <div class="section-label"><i class="fas fa-star"></i> اخترنا لك</div>
        <div class="grid-layout">
            <div class="grid-tile" onclick="quick('ميثم التمار')">ميثم التمار</div>
            <div class="grid-tile" onclick="quick('أباذر الحلواجي')">أباذر الحلواجي</div>
            <div class="grid-tile" onclick="quick('عامر الكاظمي')">عامر الكاظمي</div>
            <div class="grid-tile" onclick="quick('باسم الكربلائي')">باسم الكربلائي</div>
            <div class="grid-tile" onclick="quick('هاني الخزعلي')">هاني الخزعلي</div>
            <div class="grid-tile" onclick="quick('عبد الحي قنبر')">عبد الحي قنبر</div>
        </div>
    </main>

    <main id="view-surahs" class="content-view"><div class="grid-layout" id="surahGrid"></div></main>
    <main id="view-duas" class="content-view"><div class="grid-layout" id="duaGrid"></div></main>
    <main id="view-favs" class="content-view"><div id="favList"></div></main>
    <main id="view-results" class="content-view"><div id="resList"></div></main>

    <!-- Mini Player Dock -->
    <div id="miniDock" class="mini-bar" onclick="openFull()">
        <div style="flex:1; overflow:hidden; margin-left:12px;">
            <div id="mTitle" style="font-size:14px; font-weight:800; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;">لم يتم الاختيار بعد</div>
            <div style="font-size:11px; color:var(--primary); font-weight:800;">جاري الاستماع الآن...</div>
        </div>
        <button class="btn-play-circle" onclick="event.stopPropagation(); togglePlay()">
            <i class="fas fa-play" id="mIcon"></i>
        </button>
    </div>

    <!-- Full Immersive Player -->
    <div id="fullPlayer" class="full-player">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <i class="fas fa-chevron-down" style="font-size:32px; color:var(--primary)" onclick="closeFull()"></i>
            <div style="font-weight:900; color:var(--primary);">تطبيق ذاكر - tgg4</div>
            <i class="fas fa-share-nodes" style="font-size:24px;" onclick="shareApp()"></i>
        </div>

        <div style="position:relative; width:fit-content; margin:auto;">
            <div class="disk-art"><i class="fas fa-quran"></i></div>
            <!-- Intelligent Loader -->
            <div id="playerLoader" class="loader-wrap">
                <div class="spin-loader"></div>
                <p style="color:white; font-size:13px; margin-top:15px; font-weight:800;">جاري تحضير التلاوة...</p>
            </div>
        </div>

        <h2 id="fTitle" style="font-size:19px; font-weight:900; margin-top:15px; padding: 0 10px;">-</h2>
        <button id="btn-manual-trigger" onclick="forceUnlock()">اضغط لبدء الصوت الآن</button>

        <div class="progress-container">
            <div class="bar-bg" id="pBar" onclick="seekAudio(event)">
                <div class="bar-fill" id="pFill"></div>
            </div>
            <div class="time-labels">
                <span id="cTime">00:00</span>
                <span id="tTime">00:00</span>
            </div>
        </div>

        <div class="main-controls">
            <i class="fas fa-backward-step" style="font-size:35px; color:var(--primary)" onclick="nextPrev(-1)"></i>
            <button class="btn-big-play" onclick="togglePlay()"><i class="fas fa-play" id="fIcon"></i></button>
            <i class="fas fa-forward-step" style="font-size:35px; color:var(--primary)" onclick="nextPrev(1)"></i>
        </div>

        <div style="margin-top:60px; display:flex; justify-content:space-around; align-items:center; color:var(--muted)">
            <div onclick="cycleSpeed()" style="cursor:pointer; font-weight:800;"><i class="fas fa-gauge-high"></i> <span id="speedTxt">1.0x</span></div>
            <div onclick="toggleCurrentFav()" style="cursor:pointer; font-weight:800;"><i id="fHeart" class="far fa-heart"></i> حفظ</div>
        </div>
    </div>

    <!-- Bottom Navbar -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchView('home', this)"><i class="fas fa-house"></i><span>الرئيسية</span></div>
        <div class="nav-item" onclick="switchView('surahs', this)"><i class="fas fa-book-open-reader"></i><span>السور</span></div>
        <div class="nav-item" onclick="switchView('duas', this)"><i class="fas fa-kaaba"></i><span>الأدعية</span></div>
        <div class="nav-item" onclick="switchView('favs', this)"><i class="fas fa-bookmark"></i><span>المفضلة</span></div>
    </nav>

    <audio id="corePlayer" style="display:none"></audio>

    <script>
        const surahs = ["الفاتحة", "البقرة", "آل عمران", "النساء", "المائدة", "الأنعام", "الأعراف", "الأنفال", "التوبة", "يونس", "هود", "يوسف", "الرعد", "إبراهيم", "الحجر", "النحل", "الإسراء", "الكهف", "مريم", "طه", "الأنبياء", "الحج", "المؤمنون", "النور", "الفرقان", "الشعراء", "النمل", "القصص", "العنكبوت", "الروم", "لقمان", "السجدة", "الأحزاب", "سبأ", "فاطر", "يس", "الصافات", "ص", "الزمر", "غافر", "فصلت", "الشورى", "الزخرف", "الدخان", "الجاثية", "الأحقاف", "محمد", "الفتح", "الحجرات", "ق", "الذاريات", "الطور", "النجم", "القمر", "الرحمن", "الواقعة", "الحديد", "المجادلة", "الحشر", "الممتحنة", "الصف", "الجمعة", "المنافقون", "التغابن", "الطلاق", "التحريم", "الملك", "القلم", "الحاقة", "المعارج", "نوح", "الجن", "المزمل", "المدثر", "القيامة", "الإنسان", "المرسلات", "النبأ", "النازعات", "عبس", "التكوير", "الانفطار", "المطففين", "الانشقاق", "البروج", "الطارق", "الأعلى", "الغاشية", "الفجر", "البلد", "الشمس", "الليل", "الضحى", "الشرح", "التين", "العلق", "القدر", "البينة", "الزلزلة", "العاديات", "القارعة", "التكاثر", "العصر", "الهمزة", "الفيل", "قريش", "الماعون", "الكوثر", "الكافرون", "النصر", "المسد", "الإخلاص", "الفلق", "الناس"];
        const duas = ["دعاء كميل", "دعاء التوسل", "دعاء الندبة", "زيارة عاشوراء", "حديث الكساء", "دعاء الصباح", "دعاء العهد", "زيارة وارث", "دعاء الجوشن الكبير", "المناجاة الشعبانية", "زيارة أمين الله", "دعاء المشلول"];
        
        const audio = document.getElementById('corePlayer');
        let playlist = [];
        let currentIdx = -1;
        let favs = JSON.parse(localStorage.getItem('zakir_favs_v23')) || [];

        function init() {
            document.getElementById('surahGrid').innerHTML = surahs.map(s => `<div class="grid-tile" onclick="quick('سورة ${s}')">${s}</div>`).join('');
            document.getElementById('duaGrid').innerHTML = duas.map(d => `<div class="grid-tile" onclick="quick('${d}')">${d}</div>`).join('');
            if(localStorage.getItem('zakir_theme') === 'dark') document.body.setAttribute('data-theme', 'dark');
            refreshFavs();
        }

        async function playTrack(idx, list) {
            playlist = list;
            currentIdx = idx;
            const track = playlist[idx];
            
            // ⚡️ تحرير محرك الصوت فوراً (إجراء استباقي)
            audio.pause();
            audio.src = "";
            audio.load();
            
            // تحديث الواجهة فوراً
            openFull();
            document.getElementById('fTitle').innerText = track.title;
            document.getElementById('mTitle').innerText = track.title;
            document.getElementById('miniDock').style.display = 'flex';
            
            const loader = document.getElementById('playerLoader');
            const forceBtn = document.getElementById('btn-manual-trigger');
            loader.style.display = 'flex';
            forceBtn.style.display = 'none';

            try {
                // جلب الرابط من الـ API
                const response = await fetch("https://api.vidssave.com/api/contentsite_api/media/parse", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    referrerPolicy: "no-referrer",
                    body: `auth=20250901majwlqo&domain=api-ak.vidssave.com&origin=source&link=${encodeURIComponent(track.url)}`
                });
                
                const res = await response.json();
                const link = res.data.resources.find(r => r.type === 'audio' || r.format === 'mp3').download_url;
                
                audio.src = link.startsWith('//') ? 'https:' + link : link;
                
                // محاولة التشغيل المباشرة
                audio.play().then(() => {
                    loader.style.display = 'none';
                }).catch(() => {
                    // إذا منع المتصفح التشغيل (بسبب تأخر الـ API)
                    loader.style.display = 'none';
                    forceBtn.style.display = 'block';
                });

                // مزامنة شاشة القفل
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: track.title, artist: 'أبو الحسن tgg4',
                        artwork: [{ src: 'https://via.placeholder.com/512/10b981/ffffff?text=tgg4', sizes: '512x512', type: 'image/png' }]
                    });
                    navigator.mediaSession.setActionHandler('seekto', (d) => { audio.currentTime = d.seekTime; syncSys(); });
                    navigator.mediaSession.setActionHandler('play', () => audio.play());
                    navigator.mediaSession.setActionHandler('pause', () => audio.pause());
                }
                updateFavIcon();
            } catch (e) {
                loader.style.display = 'none';
                alert("تعذر جلب التلاوة. أبو الحسن ينصحك باستخدام Chrome.");
            }
        }

        function forceUnlock() { audio.play(); document.getElementById('btn-manual-trigger').style.display = 'none'; }

        // Core Audio Logic (The Fix)
        function syncSys() {
            if ('mediaSession' in navigator && 'setPositionState' in navigator.mediaSession) {
                if (audio.duration && isFinite(audio.duration)) {
                    navigator.mediaSession.setPositionState({
                        duration: audio.duration,
                        playbackRate: audio.playbackRate,
                        position: audio.currentTime
                    });
                }
            }
        }

        audio.onplaying = () => { document.getElementById('playerLoader').style.display = 'none'; };
        audio.onplay = () => { document.getElementById('fIcon').className = 'fas fa-pause'; document.getElementById('mIcon').className = 'fas fa-pause'; syncSys(); };
        audio.onpause = () => { document.getElementById('fIcon').className = 'fas fa-play'; document.getElementById('mIcon').className = 'fas fa-play'; };

        audio.ontimeupdate = () => {
            if(!audio.duration || isNaN(audio.duration)) return;
            const pct = (audio.currentTime / audio.duration) * 100;
            document.getElementById('pFill').style.width = pct + '%';
            document.getElementById('cTime').innerText = fmt(audio.currentTime);
            document.getElementById('tTime').innerText = fmt(audio.duration);
            if(Math.floor(audio.currentTime) % 2 === 0) syncSys();
        };

        function seekAudio(e) {
            const rect = document.getElementById('pBar').getBoundingClientRect();
            const x = e.clientX - rect.left;
            const pct = 1 - (x / rect.width); // RTL Calculation
            audio.currentTime = pct * audio.duration;
            syncSys();
        }

        async function performSearch() {
            const q = document.getElementById('qInput').value.trim();
            if(!q) return;
            switchView('results', null);
            document.getElementById('resList').innerHTML = '<p style="text-align:center; padding:30px; opacity:0.6;">جاري البحث عن تلاوات مباركة...</p>';
            try {
                const response = await fetch("https://vidssave.com/api/proxy", {
                    method: "POST", headers: { "Content-Type": "application/json" }, referrerPolicy: "no-referrer",
                    body: JSON.stringify({ url: "/media/hot_list", data: { hot_type: "ytb", keyword: q } })
                });
                const data = await response.json();
                const items = data.data.items || [];
                document.getElementById('resList').innerHTML = items.map((item, index) => `
                    <div class="track-tile">
                        <div class="track-meta" onclick='playTrack(${index}, ${JSON.stringify(items).replace(/'/g, "&apos;")})'>
                            <h4>${item.title}</h4>
                        </div>
                        <button class="btn-play-circle" onclick='playTrack(${index}, ${JSON.stringify(items).replace(/'/g, "&apos;")})'><i class="fas fa-play"></i></button>
                    </div>
                `).join('');
            } catch (e) { }
        }

        // UI Helpers
        function fmt(s) { if(isNaN(s)) return "00:00"; const m = Math.floor(s/60), sec = Math.floor(s%60); return (m<10?'0'+m:m)+':'+(sec<10?'0'+sec:sec); }
        function togglePlay() { audio.paused ? audio.play() : audio.pause(); }
        function switchView(id, el) {
            document.querySelectorAll('.content-view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + id).classList.add('active');
            if(el) { document.querySelectorAll('.nav-item').forEach(d => d.classList.remove('active')); el.classList.add('active'); }
        }
        function toggleDark() { const isD = document.body.hasAttribute('data-theme'); isD ? document.body.removeAttribute('data-theme') : document.body.setAttribute('data-theme', 'dark'); localStorage.setItem('zakir_theme', isD ? 'light' : 'dark'); }
        function quick(q) { document.getElementById('qInput').value = q; performSearch(); }
        function openFull() { document.getElementById('fullPlayer').style.display = 'flex'; }
        function closeFull() { document.getElementById('fullPlayer').style.display = 'none'; }
        function nextPrev(dir) { if(currentIdx+dir >= 0 && currentIdx+dir < playlist.length) playTrack(currentIdx+dir, playlist); }
        function cycleSpeed() { const s = [1, 1.25, 1.5, 2, 0.75]; let n = s[(s.indexOf(audio.playbackRate) + 1) % s.length]; audio.playbackRate = n; document.getElementById('speedTxt').innerText = n + 'x'; }
        function setSleepTimer() { const m = prompt("إيقاف بعد (دقائق):", "30"); if(m) setTimeout(() => audio.pause(), m*60000); }
        function toggleCurrentFav() { if(currentIdx === -1) return; const t = playlist[currentIdx]; const i = favs.findIndex(f => f.url === t.url); i > -1 ? favs.splice(i, 1) : favs.push(t); localStorage.setItem('zakir_favs_v23', JSON.stringify(favs)); updateFavIcon(); refreshFavs(); }
        function updateFavIcon() { if(currentIdx === -1) return; const isF = favs.some(f => f.url === playlist[currentIdx].url); document.getElementById('fHeart').className = isF ? 'fas fa-heart' : 'far fa-heart'; document.getElementById('fHeart').style.color = isF ? 'red' : ''; }
        function refreshFavs() { document.getElementById('favList').innerHTML = favs.map((t, i) => `<div class="track-tile"><div class="track-meta" onclick='playTrack(${i}, ${JSON.stringify(favs).replace(/'/g, "&apos;")})'><h4>${t.title}</h4></div><button class="btn-play-circle" onclick='playTrack(${i}, ${JSON.stringify(favs).replace(/'/g, "&apos;")})'><i class="fas fa-play"></i></button></div>`).join(favs.length?'':'<p style="text-align:center; padding-top:50px; opacity:0.5;">لا توجد محفوظات</p>'); }
        function showHelp() { alert("ذاكر\nتطوير: أبو الحسن tgg4\nنسألكم الدعاء لي ولوالديّ بالتوفيق والقبول."); }
        function shareApp() { alert("تطبيق ذاكر - tgg4\nانسخ رابط الموقع لمشاركته مع من تحب."); }

        init();
        document.getElementById('qInput').onkeypress = (e) => { if(e.key === 'Enter') performSearch(); };
    </script>
</body>
</html>

 
